function loadLocalSettings(){notifyWindow=new Notify;localSettings=simpleStorage.get("smallrss");localSettings==undefined&&(localSettings={showAll:!1})}function saveLocalSettings(){simpleStorage.set("smallrss",localSettings)}function initialiseFeeds(n){feeds=n;feeds.length==1&&feeds[0].id==""&&(feeds=[]);feeds.selectedFeed=null;feeds.selectedFeedGroup=null;feeds.selectedFeedArticles=null;feeds.selectedFeedArticle=null;buildTreeFromFeeds();refreshFeedCounts();$("body").keydown(handleKeyPress)}function buildTreeFromFeeds(){var t,i,n;for(feeds.allGroupsSection=$('section[name="GroupsSection"]'),feeds.selectedFeedSection=$('section[name="SelectedFeedSection"]'),feeds.selectedArticleSection=$('section[name="SelectedArticleSection"]'),t=0;t<feeds.length;t++)i=feeds[t],n='<section id="'+i.id+'" data-count="0" class="group-section">',n+="<div>",n+=i.item,n+=' <span class="group-unread-count"><\/span>',n+="<\/div>",n+=buildItemsFromFeed(i),n+="<\/section>",feeds.allGroupsSection.append(n);feeds.allGroupsSection.append('<div><button id="refresh-feed-status" title="Refresh all feeds">Refresh Feed Status<\/button><\/div>');localSettings.showAll||($("section",feeds.allGroupsSection).children("article").hide(),$("li",feeds.allGroupsSection).hide());$(".group-section div",feeds.allGroupsSection).click(toggleShowAll);$(".feed-list li",feeds.allGroupsSection).click(onFeedClicked);$("#refresh-feed-status",feeds.allGroupsSection).click(function(){refreshFeedCounts()})}function buildItemsFromFeed(n){for(var r,t='<article><ul class="feed-list">',i=0;i<n.items.length;i++)r=n.items[i],t+='<li id="'+r.id+'" data-count="0">',t+=r.item,t+=' <span class="item-unread-count"><\/span>',t+="<\/li>";return t+"<\/ul><\/article>"}function refreshFeedCounts(n){console.log("refreshing feed count");notifyWindow.show("Refreshing feeds...",!1);$.getJSON(smallrss_config.feedstatus_api,function(t){var r,i,e,u,f,o;for(notifyWindow.close(),r=0;r<feeds.length;r++)for(i=feeds[r],i.count=0,u=0;u<i.items.length;u++)f=i.items[u],f.count=0;for(r=0;r<t.length;r++){if(i=t[r],e=findGroup(i.label),e==null)return;for(e.count=i.unread,u=0;u<i.items.length;u++){if(f=i.items[u],o=findItemInGroup(e,f.value),o==null)return;o.count=f.unread}}console.log("feed counts updated; updating UI");updateUI();n!=undefined&&n()}).fail(function(){notifyWindow.show("Could not refresh, reloading...",!1);console.log("failed refresh, reloading");location.reload()})}function findGroup(n){for(var t=0;t<feeds.length;t++)if(feeds[t].id==n)return feeds[t];return null}function findItemInGroup(n,t){for(var r=n.items,i=0;i<r.length;i++)if(r[i].id==t)return r[i];return null}function autoRefreshFeedStatus(){feeds.autoRefreshFeedStatusTimer!=undefined&&feeds.autoRefreshFeedStatusTimer!=0&&(console.log("clearing auto refresh timer: "+feeds.autoRefreshFeedStatusTimer),window.clearTimeout(feeds.autoRefreshFeedStatusTimer),feeds.autoRefreshFeedStatusTimer=0);feeds.selectedFeedArticle==null&&feeds.selectedFeed==null&&(feeds.autoRefreshFeedStatusTimer=window.setTimeout(function(){feeds.autoRefreshFeedStatusTimer=0;refreshFeedCounts()},6e5),console.log("setup auto refresh feed status timer: "+feeds.autoRefreshFeedStatusTimer))}function updateUI(){if(autoRefreshFeedStatus(),feeds.allGroupsSection.hide(),feeds.selectedFeedSection.hide(),feeds.selectedArticleSection.hide(),feeds.selectedFeedArticle!=null){updateSelectedArticle();feeds.selectedArticleSection.show();return}if(feeds.selectedFeed!=null){updateSelectedFeed();feeds.selectedFeedSection.show();return}updateFeedGroups();feeds.allGroupsSection.show()}function updateFeedGroups(){for(var n,u,f,t,e,i,r=0;r<feeds.length;r++)for(n=feeds[r],n.count==undefined&&(n.count=0),u=$('section[id="'+n.id+'"]',feeds.allGroupsSection),u.attr("data-count",n.count),i=$(".group-unread-count",u),n.count==0?i.text(""):i.text("("+n.count+")"),f=0;f<n.items.length;f++)t=n.items[f],t.count==undefined&&(t.count=0),e=$('li[id="'+t.id+'"]',u),e.attr("data-count",t.count),i=$(".item-unread-count",e),t.count==0?i.text(""):i.text("("+t.count+")");$("section",feeds.allGroupsSection).children("article").show();$("li",feeds.allGroupsSection).show();localSettings.showAll||($('section[data-count="0"]',feeds.allGroupsSection).children("article").hide(),$('li[data-count="0"]',feeds.allGroupsSection).hide())}function updateSelectedFeed(){feeds.selectedFeedSection.empty();feeds.selectedFeedSection.append(buildFeedArticles());$(".feed-title").click(backToAllFeeds);$(".article-title, .article-summary, .article-date").click(showArticle);$("tbody > tr > td.article-read button").click(toggleArticleRead);$("thead > tr > td.article-read button").click(markAllArticlesRead);$("button.show-all-articles").click(showAllArticles);smallrss_config.connectedToSave&&$(".article-save button").click(saveArticle)}function buildFeedArticles(){var n='<div class="feed-title">'+feeds.selectedFeedGroup.item+" &gt; "+feeds.selectedFeed.item+" ("+feeds.selectedFeed.count+")<\/div>",i,t;for(n+='<table class="article-list">',n+='<thead><tr><td class="article-title">Title<\/td><td class="article-summary">Summary<\/td><td class="article-date">Posted<\/td>'+(smallrss_config.connectedToSave?'<td class="article-save">&nbsp;<\/td>':"")+'<td class="article-read"><button class="image" title="Mark all as read"><img src="'+smallrss_config.imageroot+'images/markread.png" alt="Mark all as read"><\/button><\/td><\/tr><\/thead>',n+="<tbody>",i=0;i<feeds.selectedFeedArticles.length;i++)t=feeds.selectedFeedArticles[i],n+='<tr data-article-id="'+t.story+'" class="article'+(t.read?" article-marked-read":"")+(feeds.focusedArticle!=null&&feeds.focusedArticle.story==t.story?" focused":"")+'">',n+='<td class="article-title">'+t.heading+"<\/td>",n+='<td class="article-summary">'+t.article+"<\/td>",n+='<td class="article-date">'+t.posted+"<\/td>",smallrss_config.connectedToSave&&(n+='<td class="article-save"><button class="image" title="Save to Raindrop.io"><img src="'+smallrss_config.imageroot+'images/pocket.png" alt="Save to Raindrop.io"><\/button><\/td>'),n+='<td class="article-read"><button class="image" title="Mark as '+(t.read?"unread":"read")+'">'+(t.read?'<img src="'+smallrss_config.imageroot+'images/markunread.png" alt="Mark as unread">':'<img src="'+smallrss_config.imageroot+'images/markread.png" alt="Mark as read">')+"<\/button><\/td>",n+="<\/tr>";return n+="<\/tbody><\/table>",n+="<div>",n+='<button class="show-all-articles">'+(smallrss_config.showingAllArticles?"Show unread articles":"Show all articles")+"<\/button>",feeds.selectedFeed.link!=""&&(n+=' <a href="'+feeds.selectedFeed.link+'" target="_blank">'+feeds.selectedFeed.link+"<\/a>"),n+"<\/div>"}function showAllArticles(){console.log("toggle showing all articles");smallrss_config.showingAllArticles=!smallrss_config.showingAllArticles;$(this).text(smallrss_config.showingAllArticles?"Show unread articles":"Show all articles");notifyWindow.show("Updating articles...",!1);$.post(smallrss_config.feedstatus_api,{showall:smallrss_config.showingAllArticles},function(){(notifyWindow.close(),feeds.selectedFeed!=null&&feeds.selectedFeedGroup!=null)&&loadArticlesForFeedAndGroup(feeds.selectedFeed,feeds.selectedFeedGroup)}).fail(function(){notifyWindow.show("Could not update articles, reloading...",!1);console.log("failed feed status api call, reloading");location.reload()})}function showArticle(){var n=$(this).parent("tr").attr("data-article-id");console.log("show article: "+n);handleArticleClicked(n)}function handleArticleClicked(n){console.log("calling article.json for article "+n);notifyWindow.show("Loading article...",!1);$.getJSON(smallrss_config.article_api+"/"+n,function(t){notifyWindow.close();feeds.selectedFeedArticle=t;markArticleId(n,!0,function(){updateUI();$(window).scrollTop(0)})}).fail(function(){notifyWindow.show("Could not load article",!0)})}function saveArticle(){if(feeds.selectedFeedArticles!=null&&smallrss_config.connectedToSave){var n=$(this).parents("tr").attr("data-article-id");console.log("saving article "+n);saveArticleId(n,function(){console.log("saved article "+n+", now marking as read");markArticleId(n,!0,function(){updateUI()})})}}function saveArticleId(n,t){console.log("calling save api for article "+n);notifyWindow.show("Saving...",!1);$.post(smallrss_config.save_api,{articleId:n},function(i){notifyWindow.show("Saved.",!0);console.log("save api completed for article "+n+": "+i.saved);t!=undefined&&t!=null&&t(n)}).fail(function(){notifyWindow.show("Could not save article",!0)})}function markAllArticlesRead(){var t,r,i,n;if(console.log("mark all articles read"),feeds.selectedFeedArticles!=null){for(t=0,r=!1,i=0;i<feeds.selectedFeedArticles.length;i++)n=feeds.selectedFeedArticles[i],n.story>t&&(t=n.story),n.read||(n.read=!0,r=!0);r?(notifyWindow.show("Marking all read...",!1),$.post(smallrss_config.article_api,{feedId:feeds.selectedFeed.id,read:!0,maxStoryId:t,offsetId:getUtcOffset()},function(){notifyWindow.close();console.log("marked all articles read");feeds.selectedFeed.count=0;updateUI()}).fail(function(){notifyWindow.show("Could not mark all read",!0)})):console.log("all articles already read, nothing to do")}}function toggleArticleRead(){if(feeds.selectedFeedArticles!=null){var n=$(this).parents("tr").attr("data-article-id");toggleArticleIdRead(n)}}function toggleSelectedArticleRead(){feeds.selectedFeedArticle!=null&&toggleArticleIdRead(feeds.selectedFeedArticle.id)}function updateSelectedFeedCount(){for(var n=0,t=0;t<feeds.selectedFeedArticles.length;t++)n+=feeds.selectedFeedArticles[t].read?0:1;console.log("updated feed "+feeds.selectedFeed.id+" count to "+n);feeds.selectedFeed.count=n}function toggleArticleIdRead(n){var u,i,r,t;for(console.log("mark article read: "+n),u=0,i=null,r=0;r<feeds.selectedFeedArticles.length;r++)t=feeds.selectedFeedArticles[r],t.story==n&&(t.read=!t.read,i=t),u+=t.read?0:1;feeds.selectedFeed.count=u;i!=null?(notifyWindow.show("Marking as "+(i.read?"read":"unread")+"...",!1),$.post(smallrss_config.article_api,{feedId:feeds.selectedFeed.id,storyId:n,read:i.read},function(){notifyWindow.close();updateUI()}).fail(function(){notifyWindow.show("Could not mark article as read/unread",!0)})):updateUI()}function updateSelectedArticle(){feeds.selectedArticleSection.empty();feeds.selectedArticleSection.append(buildFeedArticle());$(".feed-title").click(backToFeedArticles);$("button.toggle-read").click(toggleSelectedArticleRead);$(".next-article").click(markCurrentlySelectedArticleAsRead);smallrss_config.connectedToSave&&$("button.send-to").click(saveCurrentlySelectedArticle)}function buildFeedArticle(){for(var n,t=null,i=0;i<feeds.selectedFeedArticles.length;i++)if(feeds.selectedFeedArticles[i].story==feeds.selectedFeedArticle.id){t=feeds.selectedFeedArticles[i];break}return t==null&&console.log("Cannot find article summary for story "+feeds.selectedFeedArticle.id),n='<div class="feed-title">'+feeds.selectedFeedGroup.item,n+=" &gt; "+feeds.selectedFeed.item+" ("+feeds.selectedFeed.count+")",n+="<\/div>",n+="<div>",n+='<div><span class="article-info">'+t.posted+"<br><em>"+feeds.selectedFeedArticle.author+'<\/em><\/span><span class="article-actions">'+(smallrss_config.connectedToSave?'<button class="send-to image" title="Send to Raindrop.io"><img src="'+smallrss_config.imageroot+'images/pocket.png" alt="Send to Raindrop.io"><\/button>':"")+'<button class="toggle-read image" title="Mark as '+(t.read?"unread":"read")+'">'+(t.read?'<img src="'+smallrss_config.imageroot+'images/markunread.png" alt="Mark as unread">':'<img src="'+smallrss_config.imageroot+'images/markread.png" alt="Mark as read">')+"<\/button><\/span><\/div>",n+='<div class="article-heading"><a href="'+feeds.selectedFeedArticle.url+'" target="_blank">'+t.heading+"<\/a><\/div>",n+="<div>"+feeds.selectedFeedArticle.body+"<\/div>",n+="<div>"+(smallrss_config.connectedToSave?'<button class="send-to image" title="Send to Raindrop.io"><img src="'+smallrss_config.imageroot+'images/pocket.png" alt="Send to Raindrop.io"><\/button>':"")+'<span class="article-actions"><button class="next-article image" title="Next article"><img src="'+smallrss_config.imageroot+'images/next.png" alt="Next article"><\/button><\/span><\/div>',n+"<\/div>"}function toggleShowAll(){localSettings.showAll=!localSettings.showAll;saveLocalSettings();updateUI();var n=$(this);console.log("group clicked: "+n.parent().attr("id"));$(window).scrollTop(n.position().top)}function onFeedClicked(){handleFeedClicked($(this))}function handleFeedClicked(n){var t=findGroup(n.parents("section").attr("id")),i;t!=null&&(i=findItemInGroup(t,n.attr("id")),i!=null)&&loadArticlesForFeedAndGroup(i,t)}function loadArticlesForFeedAndGroup(n,t){console.log("feed clicked: #"+n.id+"="+n.item+" (group#"+t.id+"="+t.item+")");notifyWindow.show("Loading articles...",!1);$.getJSON(smallrss_config.feed_api+"/"+n.id+"?offset="+getUtcOffset(),function(i){notifyWindow.close();feeds.selectedFeed=n;feeds.selectedFeedGroup=t;feeds.selectedFeedArticles=i;updateSelectedFeedCount();updateUI()}).fail(function(){notifyWindow.show("Could not load articles, reloading...",!1);console.log("failed loading articles, reloading");location.reload()})}function backToAllFeeds(){if(feeds.selectedFeed!=null&&feeds.selectedFeedGroup!=null){var n=$('section[id="'+feeds.selectedFeedGroup.id+'"] li[id="'+feeds.selectedFeed.id+'"]',feeds.allGroupsSection);feeds.selectedFeed=null;feeds.selectedFeedGroup=null;feeds.selectedFeedArticles=null;refreshFeedCounts(function(){feeds.selectedFeedSection.empty();console.log("back to feed: "+n.attr("id"));$(window).scrollTop(n.position().top)})}}function backToFeedArticles(){var n,t;feeds.selectedFeedArticle!=null&&(n=feeds.selectedFeedArticle.id,feeds.selectedFeedArticle=null,feeds.selectedArticleSection.empty(),updateUI(),t=$('table.article-list tbody tr[data-article-id="'+n+'"]',feeds.selectedFeedSection),console.log("back to feed articles: "+n),$(window).scrollTop(t.position().top))}function markArticleId(n,t,i){for(var r,u=null,f=!1,o=0,s=!1,e=0;e<feeds.selectedFeedArticles.length;e++)r=feeds.selectedFeedArticles[e],r.story==n?(r.read!=t&&(r.read=t,s=!0),f=!0):f&&u==null&&!r.read&&(u=r),f||r.read||(u=r),o+=r.read?0:1;feeds.selectedFeed.count=o;s?(console.log("letting server know that story "+n+" should be marked read/unread: "+t),notifyWindow.show("Marking as "+(t?"read":"unread")+"...",!1),$.post(smallrss_config.article_api,{feedId:feeds.selectedFeed.id,storyId:n,read:t},function(){notifyWindow.close();i!=undefined&&i!=null&&i(u)}).fail(function(){notifyWindow.show("Could not mark article as read/unread",!0)})):i!=undefined&&i!=null&&i(u)}function markCurrentlySelectedArticleAsRead(){markArticleIdAsReadAndMoveToNext(feeds.selectedFeedArticle.id)}function markArticleIdAsReadAndMoveToNext(n){console.log("marking story as read: "+n);markArticleId(n,!0,function(n){n!=null?(console.log("show next article: "+n.story),handleArticleClicked(n.story)):(console.log("no next articles, going back to all"),backToFeedArticles())})}function saveCurrentlySelectedArticle(){if(smallrss_config.connectedToSave){var n=feeds.selectedFeedArticle.id;console.log("save story: "+n);saveArticleId(n,function(){markArticleIdAsReadAndMoveToNext(n)})}}function markCurrentlyFocusedArticleAsRead(n){feeds.focusedArticle!=undefined&&feeds.focusedArticle!=null&&markArticleId(feeds.focusedArticle.story,!0,function(){updateUI();n&&focusArticle(!0)})}function saveCurrentlyFocusedArticle(){if(smallrss_config.connectedToSave&&feeds.focusedArticle!=undefined&&feeds.focusedArticle!=null){var n=feeds.focusedArticle.story;saveArticleId(n,function(){markArticleId(n,!0,function(){updateUI();focusArticle(!0)})})}}function handleKeyPress(n){if(feeds.selectedFeedArticle!=null){n.which==65||n.which==82||n.which==78?markCurrentlySelectedArticleAsRead():n.which==66||n.which==87?backToFeedArticles():n.which==85?markArticleId(feeds.selectedFeedArticle.id,!1,function(){updateUI()}):n.which==80&&saveArticleId(feeds.selectedFeedArticle.id,function(){markCurrentlySelectedArticleAsRead()});return}if(feeds.selectedFeed!=null){n.which==66||n.which==87?backToAllFeeds():n.which==74||n.which==40?(n.preventDefault(),focusArticle(!0)):n.which==75||n.which==38?(n.preventDefault(),focusArticle(!1)):n.which==65||n.which==82||n.which==78?markCurrentlyFocusedArticleAsRead(n.which==78):n.which==85?feeds.focusedArticle!=undefined&&feeds.focusedArticle!=null&&markArticleId(feeds.focusedArticle.story,!1,function(){updateUI()}):n.which==80?saveCurrentlyFocusedArticle():n.which==77?markAllArticlesRead():n.which==13&&feeds.focusedArticle!=undefined&&feeds.focusedArticle!=null&&(n.preventDefault(),handleArticleClicked(feeds.focusedArticle.story));return}if(n.which==74||n.which==40)n.preventDefault(),focusNextFeed();else if(n.which==75||n.which==38)n.preventDefault(),focusPreviousFeed();else if(n.which==13)if(feeds.focusedFeed==undefined)feeds.focusedFeed=null;else{n.preventDefault();var t=$('section.group-section li[id="'+feeds.focusedFeed.id+'"]',feeds.allGroupsSection);handleFeedClicked(t)}else n.which==82&&refreshFeedCounts()}function focusNextFeed(){focusFeed(function(){return 0},function(n,t){return t<n.length},function(n){return n+1},function(){return 0},function(n,t){return t<n.length},function(n){return n+1})}function focusPreviousFeed(){focusFeed(function(n){return n.length-1},function(n,t){return t>=0},function(n){return n-1},function(n){return n.length-1},function(n,t){return t>=0},function(n){return n-1})}function focusFeed(n,t,i,r,u,f){var v,s,c,h,o,a;feeds.focusedFeed==undefined?feeds.focusedFeed=null:(v=$('section.group-section li[id="'+feeds.focusedFeed.id+'"]',feeds.allGroupsSection),v.removeClass("focused"));var l=null,e=null,y=!1,p=function(n){return localSettings.showAll||n.count>0};for(s=n(feeds);t(feeds,s);s=i(s)){for(c=feeds[s].items,h=r(c);u(c,h);h=f(h)){if(o=c[h],y&&p(o)){e=o;break}feeds.focusedFeed!=null&&feeds.focusedFeed.id==o.id&&(y=!0);l==null&&p(o)&&(l=o)}if(e!=null)break}e==null&&(e=l);e!=null&&(console.log("focusing "+e.id+" ("+e.item+")"),a=$('section.group-section li[id="'+e.id+'"]',feeds.allGroupsSection),a.addClass("focused"),feeds.focusedFeed=e,$(window).scrollTop(a.position().top))}function focusArticle(n){var e,i,r,f;feeds.focusedArticle==undefined?feeds.focusedArticle=null:(e=$('table.article-list tbody tr[data-article-id="'+feeds.focusedArticle.story+'"]',feeds.selectedFeedSection),e.removeClass("focused"));var u=null,t=null,o=!1,s=n?0:feeds.selectedFeedArticles.length-1,h=function(t){return n?t<feeds.selectedFeedArticles.length:t>=0},c=function(t){return n?t+1:t-1};for(i=s;h(i);i=c(i)){if(r=feeds.selectedFeedArticles[i],o){t=r;break}feeds.focusedArticle!=null&&feeds.focusedArticle.story==r.story&&(o=!0);u==null&&(u=r)}t==null&&(t=u);t!=null&&(console.log("focusing "+t.story+" ("+t.heading+")"),f=$('table.article-list tbody tr[data-article-id="'+t.story+'"]',feeds.selectedFeedSection),f.addClass("focused"),feeds.focusedArticle=t,$(window).scrollTop(f.position().top))}function getUtcOffset(){return(new Date).getTimezoneOffset()}function Notify(){var n=this;this._notifyItem=$('<div class="notify"/>');this._showTimeoutId=0;this._notifyItem.hide();$("body").append(this._notifyItem);this.show=function(t,i){n._notifyItem.text(t);n._showTimeoutId===0?(console.log("showing notification"),n._notifyItem.show()):(window.clearTimeout(n._showTimeoutId),n._showTimeoutId=0,console.log("cleared previous timeout "+n._showTimeoutId));i&&(n._showTimeoutId=window.setTimeout(function(){n._close()},3e3))};this.close=function(){n._showTimeoutId=window.setTimeout(function(){n._close()},750)};this._close=function(){console.log("closing notification");n._notifyItem.hide();n._notifyItem.text("");n._showTimeoutId=0}}var localSettings,feeds,notifyWindow;coerceToArrayBuffer=function(n,t){var r,u,i;if(typeof n=="string"){for(n=n.replace(/-/g,"+").replace(/_/g,"/"),r=window.atob(n),u=new Uint8Array(r.length),i=0;i<r.length;i++)u[i]=r.charCodeAt(i);n=u}if(Array.isArray(n)&&(n=new Uint8Array(n)),n instanceof Uint8Array&&(n=n.buffer),!(n instanceof ArrayBuffer))throw new TypeError("could not coerce '"+t+"' to ArrayBuffer");return n};coerceToBase64Url=function(n){var i,r,t;if(Array.isArray(n)&&(n=Uint8Array.from(n)),n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array){for(i="",r=n.byteLength,t=0;t<r;t++)i+=String.fromCharCode(n[t]);n=window.btoa(i)}if(typeof n!="string")throw new Error("could not coerce to string");return n.replace(/\+/g,"-").replace(/\//g,"_").replace(/=*$/g,"")};